<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>django-websocket</title>
    <script type="text/javascript" src="jquery-1.8.3.min.js"></script>
    <script type="text/javascript" src="echarts.min.js"></script>
</head>
<body>
<br>
<input type="text" id="message" value="200"/>
<button type="button" id="connect_websocket">连接</button>
<button type="button" id="send_message">开始画图</button>
<button type="button" id="close_ht">暂停画图</button>
<button type="button" id="close_websocket">关闭接收数据</button>
<div id="messagecontainer">

</div>
<div id="main" style="width: auto;height: 800px;" align="center"></div>
    <script type="text/javascript">

var myChart = echarts.init(document.getElementById('main'));
var bs = new Array();
var xzs = new Array();

option = {
    title : {
        text: '回测',
        subtext: 'K线'
    },
    tooltip : {
        trigger: 'axis'
    },
    legend: {
        data:['回测','卖出','买入']
    },
    toolbox: {
        show : true,
        feature : {
            mark : {show: true},
            dataView : {show: true, readOnly: false},
            restore : {show: true},
            saveAsImage : {show: true}
        }
    },
    dataZoom : {
        show : true,
        realtime: true,
        start : 50,
        end : 100
    },
    xAxis : [
        {
            type : 'category',
            boundaryGap : true,
            data : [

            ]
        }
    ],
    yAxis : [
        {
            type : 'value',
            scale:true,
            splitNumber: 5,
            boundaryGap: [0.05, 0.05]
        }
    ],
    series : [
        {
            name:'回测',
            type:'k',
            data:[ // 开盘，收盘，最低，最高
            ]
        },{
            name:'卖出',
            type:'scatter',
            symbol: 'arrow',//'star3',
            symbolSize: 12,
            smooth:true,
            symbolRotate:180,

            itemStyle:{
                //symbolRotate:-90,
                normal: { color:function(p){
                    return bs[p.name];
                 }
                }
            },
            
            data: []
        },{
            name:'买入',
            type:'scatter',
            symbol: 'arrow',//'star3',
            symbolSize: 12,
            smooth:true,
            symbolRotate:0,

            itemStyle:{
                //symbolRotate:-90,
                normal: { color:function(p){
                    return bs[p.name];
                 }
                }
            },
            
            data: []
        }
    ]
};

stringToDate = function(dateStr,separator){
     if(!separator){
            separator="-";
     }
     var dateArr = dateStr.split(separator);
     var year = parseInt(dateArr[0]);
     var month;
     //处理月份为04这样的情况
     if(dateArr[1].indexOf("0") == 0){
         month = parseInt(dateArr[1].substring(1));
     }else{
          month = parseInt(dateArr[1]);
     }
     var day = parseInt(dateArr[2]);
     var date = new Date(year,month -1,day);
     return date;
 }

var k_x = new Array();
var k_y = new Array();
var y_x = new Array();
var y_y = new Array();
var y_y2 = new Array();
var is_huatu = true;
var size = $('#message').val()-0;

//myChart.setOption(option);

function timeTicket(x,y,type,side){
    // 动态数据接口 addData
    // lastIndex += 1;
    // var len2 = option.series[0].data.length;
    // var d = option.xAxis[0].data[len2-1];
    // d = stringToDate(d,'/');
    // d.setDate(d.getDate()+1);
    // d = d.getFullYear()+'/'+(d.getMonth()+1)+'/'+d.getDate();

    if(type=='k'){
        var ind = k_x.indexOf(x);
        if(ind<0){
                k_x.push(x);
                k_y.push(y);
                y_y.push('');
                y_y2.push('');
            }else{
                k_y[ind] = y;
            }
            
            if(is_huatu){
                option.xAxis[0].data=k_x.slice(-size);
                option.series[0].data=k_y.slice(-size);
                option.series[1].data=y_y.slice(-size);
                option.series[2].data=y_y2.slice(-size);
                //option.series[1].symbolRotate=y_y.slice(-size);
                myChart.setOption(option);
            }
    }else if(type=='y'){
            var ind = k_x.indexOf(x);
            
            if(ind<0){
                k_x.push(x);
                k_y.push(k_y[k_y.length-1]);
                if(side=='SELL'){
                    y_y.push(y);
                    y_y2.push('')
                }else{
                    y_y.push('');
                    y_y2.push(y)
                }
            }else{
                //y_y[ind] = y;
                if(side=='SELL'){
                    y_y[ind] = y;
                }else{
                   y_y2[ind] = y;
                }
            }
            if(is_huatu){
                option.xAxis[0].data=k_x.slice(-size);
                option.series[0].data=k_y.slice(-size);
                option.series[1].data=y_y.slice(-size);
                option.series[2].data=y_y2.slice(-size);
               myChart.setOption(option);
            }
    }else{
        option.xAxis[0].data=k_x.slice(-size);
        option.series[0].data=k_y.slice(-size);
        option.series[1].data=y_y.slice(-size);
        option.series[2].data=y_y2.slice(-size);
        myChart.setOption(option);
    }
        /*myChart.addData([
            [
                0,        // 系列索引
                option.series[0].data[lastIndex%len], // 新增数据
                false,     // 新增数据是否从队列头部插入
                false,     // 是否增加队列长度，false则自定删除原有数据，队头插入删队尾，队尾插入删队头
                d //option.xAxis[0].data[lastIndex%len]
            ]
        ]);*/
}

$(function () {
        function manages(info){
            if (window.s) {
                window.s.close();
            }
            /*创建socket连接*/
            var url = "ws://192.168.2.237:7214/"; //"ws://localhost:8000"; //  
            var socket = new WebSocket(url); //window.location.host  192.168.2.237:7214
            socket.onopen = function () {
                console.log('WebSocket open');//成功连接上Websocket
                if(info) alert('WebSocket open');
            };
            var x=null,y=null;
            socket.onmessage = function (e) {
                console.log('message: ' + e.data);//打印出服务端返回过来的数据
                var d= $.parseJSON(e.data);
                if(d.topic=='bar'){
                    x = d.datetime;
                    y=[d.open,d.close,d.high,d.low]
                    timeTicket(x,y,'k','');
                }else if(d.topic=='trade'){
                    x = d.trading_dt;
                    y = d.price;
                    //bs = d.bs;
                    if(d.side=='SELL'){
                        bs[x]='green';
                    }else{
                        bs[x]='red';
                    }
                    timeTicket(x,y,'y',d.side);
                }
            };
            // Call onopen directly if socket is already open
            if (socket.readyState == WebSocket.OPEN) socket.onopen();
            window.s = socket;
        }
        manages(false);
        $('#connect_websocket').click(function () {
            manages(true);
        });
        $('#send_message').click(function () {
            //如果未连接到websocket
            is_huatu = true;
            if (!window.s) {
                alert("websocket未连接.");
            } else {
                window.s.send($('#message').val());//通过websocket发送数据
            }
        });
        $('#close_websocket').click(function () {
            if (window.s) {
                window.s.close();//关闭websocket
                console.log('websocket已关闭');
            }
        });
        $('#close_ht').click(function () {
            is_huatu = false;
            size = $('#message').val()-0;
            timeTicket('','','','');
        });
    });


//var t=setInterval("timeTicket()",100);
</script>
</body>
</html>